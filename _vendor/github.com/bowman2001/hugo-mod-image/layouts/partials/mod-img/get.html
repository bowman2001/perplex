{{- /* Constants */}}
{{ $name := "mod-img/get" }}
{{ $configName := "data/mod-img" }}
{{ $errorLevel := site.Data.modImg.errorLevel | default "warning" | lower }}
{{ partial "error-level" (dict "caller" $name "level" $errorLevel "config" $configName ) }}
{{ $configErrorEnd := printf " Please check the configuration in %q" $configName }}

{{/* Arguments */}}
{{ $src := .src }}
{{ $ctx := .ctx }}

{{ $imgMap := "" }}
{{ $url := urls.Parse $src }}
{{ $args := dict "url" $url "ctx" $ctx "errorLevel" $errorLevel }}

{{ with (partial "mod-resource/func/get-with-params" $args) }}
    {{ if (eq .resource.MediaType.MainType "image") }}
        {{ $imgMap = dict "img" .resource "params" .params }}
    {{ else }}
        {{ $imgMap = dict "img" (partial "mod-img/helper/missing" $ctx) "params" .params }}
        {{ $msg := printf "The resource %q is not or does not contain an image resource." $src }}
        {{ partial "error-msg" (dict "caller" $name "ctx" $ctx "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{ end }}
{{ else }}
    {{ $imgMap = dict "img" (partial "mod-img/helper/missing" $ctx) }}
{{ end }}

{{/* Collect and sort parameters */}}
{{ $imgParams := partial "mod-img/func/params/resource" $imgMap.img }}
{{ $extraParams := dict }}
{{ $captionParams := dict }}
{{ with $imgMap.params }}
    {{ $extraParams = partial "mod-img/func/params/extra" . }}
    {{ $captionParams = partial "mod-resource/func/caption" . }}
{{ end }}
{{ $sortedParams := merge $imgParams $extraParams $captionParams }}
{{ $imgMap := dict "img" $imgMap.img "params" $sortedParams }}

{{ return $imgMap }}

