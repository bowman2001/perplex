{{ $p := partial "img/func/preprocess.html" . -}}
{{ if .a.link -}}
<a class="link-block" href="{{ .a.link | safeHTMLAttr }}"
        {{- with .a.target -}}
            {{- if in site.Params.link.target }} target="{{ . | safeHTMLAttr }}"{{ else -}}
                {{- warnf "Unable to us the 'target' attribute %s for a link. Only %s are possible." . site.Params.link.target -}}
            {{- end -}}
        {{- end -}}
        {{- with .a.rel -}}
    {{- if in site.Params.link.rel }} rel="{{ . | safeHTMLAttr }}"{{ else -}}
        {{- warnf "Unable to us the 'rel' attribute %s for a link. Only %s are possible." . site.Params.link.rel -}}
    {{- end -}}
        {{- end -}}>
    {{- end -}}
  {{ if or (ne .a.container "no") (eq .a.card "yes") }}<span class="img__container">{{ end }}
    {{- $subType := .img.MediaType.SubType -}}
      {{- if eq $subType "svg" -}}
          {{ if (eq .a.svg "inline") }}
              {{ .img.Content | safeHTML }}
          {{ else }}
            <img src="{{ .img.RelPermalink }}"
                 class="img--transparent"
                 {{- with .a.alt }}alt="{{ . }}"{{ end -}}
                    {{- with .a.title }}title="{{ . }}"{{ end }}>
          {{ end }}
      {{- else -}}
          {{- $imgClass := "" -}}
          {{- if eq $subType "png" -}}
              {{- $imgClass = "img--transparent" -}}
          {{- end -}}
          {{- $fallbackWidth := site.Params.imaging.fallback_width -}}
          {{- $fallbackImg := $p.img.Resize (printf "%dx" (int (math.Max $fallbackWidth $p.img.Width)) ) -}}
          {{- $lqip := partial "img/func/generate-lqip.html" $p.img -}}

          <img data-src="{{ $fallbackImg.RelPermalink }}"
               data-srcset="{{ partial "img/func/generate-global-srcset.html" (dict "img" $p.img "params" $p.params "a" .a ) }}"
               data-sizes="auto"
               data-aspectratio="{{ div $p.img.Width (float $p.img.Height) }}"
               data-parentfit="cover"
                  {{- if lt (len $lqip.base64) 2048 -}}
                    src="data:image/webp;base64,{{- $lqip.base64 -}}"
                  {{- else -}}
                    src="{{ $lqip.img.RelPermalink }}"
                  {{- end -}}
               class="lazyload {{ with $imgClass -}}{{ . }}{{- end }}"
                  {{- with .a.alt -}}
                    alt="{{ . }}"
                  {{- else -}}
                      {{- warnf "No alternative description for image %s." $p.img.RelPermalink -}}
                  {{- end -}}
                  {{- with .a.title }} title="{{ . }}"{{ end -}}
               width="{{ $fallbackImg.Width }}"
               height="{{ $fallbackImg.Height }}"/>
      {{- end -}}
        {{ if or (ne .a.container "no") (eq .a.card "yes") }}</span>{{ end }}
    {{- if .a.link }}</a>{{ end -}}
